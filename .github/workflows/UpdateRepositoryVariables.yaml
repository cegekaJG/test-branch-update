name: Update Repository Variables

on:
  workflow_dispatch:
    inputs:
      test_branch:
        description: 'Name of the test branch (leave empty for test/main)'
        required: false
        type: string
        default: ''
      test_prefix:
        description: 'Prefix for feature test branches (e.g., test/)'
        required: true
        type: string
        default: 'test/'
      bot_label:
        description: 'Name of the bot label for automated PRs'
        required: true
        type: string
        default: 'Automated'
      token_name:
        description: 'Token name to use for GitHub API calls (GITHUB_TOKEN or custom secret name)'
        required: true
        type: string
        default: 'GHTOKENWORKFLOW'

permissions:
  contents: read

jobs:
  update_variables:
    name: Update Repository Variables
    runs-on: ubuntu-latest
    steps:
      - name: Validate token
        run: |
          if [ -z "${{ secrets.GHTOKENWORKFLOW }}" ]; then
            echo "::error::The GHTOKENWORKFLOW secret is required to update repository variables"
            echo "::error::Please create a Personal Access Token with 'repo' scope and add it as a secret named GHTOKENWORKFLOW"
            echo "::error::Alternatively, you can manually set repository variables in Settings > Secrets and variables > Actions > Variables"
            exit 1
          fi

      - name: Update repository variables
        env:
          GH_TOKEN: ${{ secrets.GHTOKENWORKFLOW }}
        run: |
          # Function to update or create a repository variable
          update_variable() {
            local var_name=$1
            local var_value=$2

            echo "Updating variable: ${var_name}"
            
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/actions/variables/${var_name} \
              -f name="${var_name}" \
              -f value="${var_value}" 2>/dev/null || \
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/actions/variables \
              -f name="${var_name}" \
              -f value="${var_value}"
            
            if [ $? -eq 0 ]; then
              echo "::notice::Successfully updated ${var_name}"
            else
              echo "::error::Failed to update ${var_name}"
              return 1
            fi
          }

          # Update all variables
          update_variable "UPDATETESTBRANCH_TEST_BRANCH" "${{ github.event.inputs.test_branch }}"
          update_variable "UPDATETESTBRANCH_FEATURE_TEST_PREFIX" "${{ github.event.inputs.test_prefix }}"
          update_variable "UPDATETESTBRANCH_BOT_LABEL" "${{ github.event.inputs.bot_label }}"
          update_variable "UPDATETESTBRANCH_TOKEN_NAME" "${{ github.event.inputs.token_name }}"

          echo "::notice::Repository variables updated successfully"

      - name: Display updated configuration
        run: |
          echo "### Repository Variables Updated"
          echo ""
          echo "The following repository variables have been configured:"
          echo "- **UPDATETESTBRANCH_TEST_BRANCH**: \`${{ github.event.inputs.test_branch }}\`"
          echo "- **UPDATETESTBRANCH_FEATURE_TEST_PREFIX**: \`${{ github.event.inputs.test_prefix }}\`"
          echo "- **UPDATETESTBRANCH_BOT_LABEL**: \`${{ github.event.inputs.bot_label }}\`"
          echo "- **UPDATETESTBRANCH_TOKEN_NAME**: \`${{ github.event.inputs.token_name }}\`"
          echo ""
          echo "These variables will be used by the UpdateTestBranch workflow."
