name: Update Test Branch

on:
  issue_comment:
    types:
      created

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  TEST_BRANCH: test/main
  FEATURE_TEST_PREFIX: test/
  NOTICE_COMMENT_TAG: <!-- UpdateTestBranch/NOTICE -->
  COMMIT_COMMENT_TAG: <!-- UpdateTestBranch/COMMIT -->
  BOT_LABEL: Automated
  DISABLE_COMMENTS: false
  USE_GITHUB_TOKEN: false
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  prepare_update:
    name: Prepare Update Parameters
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '!update-test')
    outputs:
      test_branch: ${{ steps.set_config.outputs.TEST_BRANCH }}
      feature_branch: ${{ steps.get_pr_info.outputs.HEAD_REF }}
      base_branch: ${{ steps.get_pr_info.outputs.BASE_REF }}
      feature_test_prefix: ${{ steps.set_config.outputs.FEATURE_TEST_PREFIX }}
      bot_label: ${{ steps.set_config.outputs.BOT_LABEL }}
      use_github_token: ${{ steps.set_config.outputs.USE_GITHUB_TOKEN == 'true' }}
      disable_comments: ${{ steps.set_config.outputs.DISABLE_COMMENTS }}
      notice_comment_tag: ${{ steps.set_config.outputs.NOTICE_COMMENT_TAG }}
    steps:
      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: rocket

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup jq'
        uses: dcarbone/install-jq-action@v3

      - name: Get PR information
        id: get_pr_info
        run: |
          pr_info=$(gh pr view ${{ github.event.issue.number }} --json headRefName,baseRefName,title)

          printf "::debug::PR info: %q\n" "$pr_info"

          if [ -z "$pr_info" ]; then
            echo "::error::Failed to get PR information. Please try again."
            exit 1
          fi

          head_ref=$(echo "$pr_info" | jq -r '.headRefName')
          base_ref=$(echo "$pr_info" | jq -r '.baseRefName')
          pr_title=$(echo "$pr_info" | jq -r '.title')

          echo "Head ref: $head_ref"
          echo "Base ref: $base_ref"
          echo "PR title: $pr_title"

          echo "HEAD_REF=$head_ref" >> $GITHUB_OUTPUT
          echo "BASE_REF=$base_ref" >> $GITHUB_OUTPUT
          echo "PR_TITLE=$pr_title" >> $GITHUB_OUTPUT

      - name: Set configuration variables
        id: set_config
        run: |
          echo "TEST_BRANCH=${{ vars.UPDATETESTBRANCH_TEST_BRANCH || env.TEST_BRANCH }}" >> $GITHUB_OUTPUT
          echo "FEATURE_TEST_PREFIX=${{ vars.UPDATETESTBRANCH_FEATURE_TEST_PREFIX || env.FEATURE_TEST_PREFIX }}" >> $GITHUB_OUTPUT
          echo "BOT_LABEL=${{ vars.UPDATETESTBRANCH_BOT_LABEL || env.BOT_LABEL }}" >> $GITHUB_OUTPUT
          echo "DISABLE_COMMENTS=${{ vars.UPDATETESTBRANCH_DISABLE_COMMENTS || env.DISABLE_COMMENTS }}" >> $GITHUB_OUTPUT
          echo "USE_GITHUB_TOKEN=${{ vars.UPDATETESTBRANCH_USE_GITHUB_TOKEN || env.USE_GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          echo "NOTICE_COMMENT_TAG=${{ vars.UPDATETESTBRANCH_NOTICE_COMMENT_TAG || env.NOTICE_COMMENT_TAG }}" >> $GITHUB_OUTPUT
          echo "COMMIT_COMMENT_TAG=${{ vars.UPDATETESTBRANCH_COMMIT_COMMENT_TAG || env.COMMIT_COMMENT_TAG }}" >> $GITHUB_OUTPUT

  check_existing_pr:
    name: Look for Existing Update PR
    needs: prepare_update
    runs-on: ubuntu-latest
    outputs:
      pr_exists: ${{ steps.check_pr.outputs.PR_EXISTS }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GH_TOKEN
        if: ${{ needs.prepare_update.outputs.use_github_token == 'false' }}
        run: |
          token='${{ secrets.GHTOKENWORKFLOW }}'
          if [ -z "$token" ]; then
            echo "::error::The GHTOKENWORKFLOW secret is required when use_github_token is false."
            exit 1
          fi
          echo "GH_TOKEN=$token" >> $GITHUB_ENV

      - name: Use GitHub Token
        if: ${{ needs.prepare_update.outputs.use_github_token == 'true' }}
        run: |
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Look for existing update PR
        id: check_pr
        env:
          TEST_BRANCH: ${{ needs.prepare_update.outputs.test_branch }}
          FEATURE_BRANCH: ${{ needs.prepare_update.outputs.feature_branch }}
          FEATURE_TEST_PREFIX: ${{ needs.prepare_update.outputs.feature_test_prefix }}
        run: |
          feature_test_branch="${FEATURE_TEST_PREFIX}${FEATURE_BRANCH}"
          
          if [ $(gh pr list --base "${TEST_BRANCH}" --head "${feature_test_branch}" --state open | wc -l) -gt 0 ]; then
            echo "PR already exists."
            echo "PR_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "No PR of ${feature_test_branch} to ${TEST_BRANCH} found."
            echo "PR_EXISTS=false" >> $GITHUB_OUTPUT
          fi

  ensure_bot_label:
    name: Ensure Bot Label Exists
    needs: [prepare_update, check_existing_pr]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GH_TOKEN
        if: ${{ needs.prepare_update.outputs.use_github_token == 'false' }}
        run: |
          token='${{ secrets.GHTOKENWORKFLOW }}'
          if [ -z "$token" ]; then
            echo "::error::The GHTOKENWORKFLOW secret is required when use_github_token is false."
            exit 1
          fi
          echo "GH_TOKEN=$token" >> $GITHUB_ENV

      - name: Use GitHub Token
        if: ${{ needs.prepare_update.outputs.use_github_token == 'true' }}
        run: |
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Ensure bot label exists
        env:
          BOT_LABEL: ${{ needs.prepare_update.outputs.bot_label }}
        run: |
          if [ -z "$(gh label list --search "${BOT_LABEL}" --limit 1)" ]; then
            gh label create "${BOT_LABEL}" --color CCCCCC --description "Automated pull requests"
            echo "::notice::Label ${BOT_LABEL} added to repository."
          fi

  call_core_workflow:
    name: Call Core Update Workflow
    needs: [prepare_update, check_existing_pr, ensure_bot_label]
    uses: ./.github/workflows/UpdateTestBranchCore.yaml
    with:
      test_branch: ${{ needs.prepare_update.outputs.test_branch }}
      feature_branch: ${{ needs.prepare_update.outputs.feature_branch }}
      base_branch: ${{ needs.prepare_update.outputs.base_branch }}
      feature_test_prefix: ${{ needs.prepare_update.outputs.feature_test_prefix }}


  create_update_pr:
    name: Create/Update Pull Request
    needs: [prepare_update, check_existing_pr, ensure_bot_label, call_core_workflow]
    runs-on: ubuntu-latest
    if: needs.call_core_workflow.outputs.skip_all == 'false' && needs.call_core_workflow.outputs.no_changes == 'false'
    outputs:
      test_pr_url: ${{ steps.create_pr.outputs.TEST_PR_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GH_TOKEN
        if: ${{ needs.prepare_update.outputs.use_github_token == 'false' }}
        run: |
          token='${{ secrets.GHTOKENWORKFLOW }}'
          if [ -z "$token" ]; then
            echo "::error::The GHTOKENWORKFLOW secret is required when use_github_token is false."
            exit 1
          fi
          echo "GH_TOKEN=$token" >> $GITHUB_ENV

      - name: Use GitHub Token
        if: ${{ needs.prepare_update.outputs.use_github_token == 'true' }}
        run: |
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Create/Update pull request
        id: create_pr
        env:
          FEATURE_BRANCH: ${{ needs.prepare_update.outputs.feature_branch }}
          BASE_BRANCH: ${{ needs.prepare_update.outputs.base_branch }}
          TEST_BRANCH: ${{ needs.prepare_update.outputs.test_branch }}
          BOT_LABEL: ${{ needs.prepare_update.outputs.bot_label }}
          FEATURE_TEST_BRANCH: ${{ needs.call_core_workflow.outputs.feature_test_branch }}
          PR_EXISTS: ${{ needs.check_existing_pr.outputs.pr_exists }}
        run: |
          feature_title="Test branch for ${FEATURE_BRANCH}"
          echo "PR title: ${feature_title}"
          body="This automated pull request adds the cherry-picked changes from \`${FEATURE_BRANCH}\` to \`${TEST_BRANCH}\`.

          **Feature Branch**: \`${FEATURE_BRANCH}\`
          **Base Branch**: \`${BASE_BRANCH}\`
          **Test Branch**: \`${TEST_BRANCH}\`"
          
          if [ "${PR_EXISTS}" == 'false' ]; then
            TEST_PR_URL=$(gh pr create \
              --base "${TEST_BRANCH}" \
              --head "${FEATURE_TEST_BRANCH}" \
              --title "${feature_title}" \
              --label "${BOT_LABEL}" \
              --body "${body}")
            echo "::notice::${TEST_PR_URL} created."
          else
            TEST_PR_URL=$(gh pr edit "${FEATURE_TEST_BRANCH}" \
              --body "${body}")
            echo "::notice::${TEST_PR_URL} updated."
          fi
          echo "TEST_PR_URL=${TEST_PR_URL}" >> $GITHUB_OUTPUT

      - name: Set pull request status
        env:
          FEATURE_TEST_BRANCH: ${{ needs.call_core_workflow.outputs.feature_test_branch }}
          CHERRY_PICK_SUCCESS: ${{ needs.call_core_workflow.outputs.cherry_pick_success }}
        run: |
          if [ "${CHERRY_PICK_SUCCESS}" == "true" ]; then
            gh pr ready "${FEATURE_TEST_BRANCH}"
          else
            gh pr ready --undo "${FEATURE_TEST_BRANCH}"
          fi

  add_reaction:
    name: Add Reaction
    needs: [prepare_update, check_existing_pr, ensure_bot_label, call_core_workflow, create_update_pr]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Add reaction based on outcome
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: ${{ needs.call_core_workflow.outputs.cherry_pick_success == 'true' && '+1' || '-1' }}

  cleanup_comments:
    name: Clean up comments
    needs: [prepare_update, check_existing_pr, ensure_bot_label, call_core_workflow, create_update_pr]
    if: always() && needs.create_update_pr.outputs.test_pr_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up old comments
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            (async () => {
              let newPrComments = [];
              if ("${{ needs.create_update_pr.outputs.test_pr_url }}") {
                const urlSubstrings = "${{ needs.create_update_pr.outputs.test_pr_url }}".split('/');
                const newPrNumber = urlSubstrings[urlSubstrings.length - 1];
                try {
                  newPrComments = await github.rest.issues.listComments({
                    issue_number: newPrNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo
                  });
                } catch (error) {
                  process.stdout.write(`::error::Error retrieving comments from ${newPrNumber}: ${error.message}\n`);
                  process.exit(1);
                }
              }
              let oldPrComments = [];
              try {
                oldPrComments = await github.rest.issues.listComments({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              } catch (error) {
                process.stdout.write(`::error::Error retrieving comments from ${context.issue.number}: ${error.message}\n`);
                process.exit(1);
              }
              const allComments = [oldPrComments, newPrComments];
              allComments.forEach(comments => {
                comments.data.forEach(comment => {
                  if (comment.user.login === 'github-actions[bot]' && comment.body.startsWith('${{ needs.prepare_update.outputs.notice_comment_tag }}')) {
                    try {
                      await github.rest.issues.deleteComment({
                        comment_id: comment.id,
                        owner: context.repo.owner,
                        repo: context.repo.repo
                      });
                      process.stdout.write(`Deleted comment ${comment.html_url}\n`);
                    } catch (error) {
                      process.stdout.write(`::notice::Error deleting comment ${comment.html_url}: ${error.message}\n`);
                    }
                  }
                });
              });
            })();

  comment_on_prs:
    name: Comment on PRs
    needs: [prepare_update, check_existing_pr, ensure_bot_label, call_core_workflow, create_update_pr]
    if: always() && needs.create_update_pr.outputs.test_pr_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Comment on test PR (on failure)
        if: needs.call_core_workflow.outputs.cherry_pick_success == 'false' && needs.prepare_update.outputs.disable_comments == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_BRANCH: ${{ needs.prepare_update.outputs.test_branch }}
          FEATURE_TEST_BRANCH: ${{ needs.call_core_workflow.outputs.feature_test_branch }}
          TEST_PR_URL: ${{ needs.create_update_pr.outputs.test_pr_url }}
          NOTICE_COMMENT_TAG: ${{ needs.prepare_update.outputs.notice_comment_tag }}
        run: |
          body="**Automatic ${TEST_BRANCH} update failed.**

          To manually resolve the merge conflicts, please follow these steps:

          1) Checkout the latest version of the branch \`${FEATURE_TEST_BRANCH}\` with the following commands:
          \`\`\`bash
          git fetch origin ${FEATURE_TEST_BRANCH}
          git checkout ${FEATURE_TEST_BRANCH}
          git reset --hard origin/${FEATURE_TEST_BRANCH}
          \`\`\`
          2) Manually cherry-pick the failing commits and resolve any conflicts.
          3) Push the changes and the PR will be updated automatically.
          4) Re-run the workflow by commenting \`!update-test\` in ${{ github.event.issue.pull_request.html_url }} again."

          gh pr comment "${TEST_PR_URL}" --body "${NOTICE_COMMENT_TAG}
          ${body}"

      - name: Comment on original PR
        if: needs.prepare_update.outputs.disable_comments == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FEATURE_BRANCH: ${{ needs.prepare_update.outputs.feature_branch }}
          TEST_BRANCH: ${{ needs.prepare_update.outputs.test_branch }}
          TEST_PR_URL: ${{ needs.create_update_pr.outputs.test_pr_url }}
          NOTICE_COMMENT_TAG: ${{ needs.prepare_update.outputs.notice_comment_tag }}
          CHERRY_PICK_SUCCESS: ${{ needs.call_core_workflow.outputs.cherry_pick_success }}
        run: |
          if [ "${CHERRY_PICK_SUCCESS}" == "true" ]; then
            body="The cherry-picked changes from \`${FEATURE_BRANCH}\` are ready to be added to the \`${TEST_BRANCH}\` branch.

            A new pull request has been created to test the changes. See ${TEST_PR_URL} for more details."
          else
            body="Unable to cherry-pick the changes from \`${FEATURE_BRANCH}\` to the \`${TEST_BRANCH}\` branch.

            A new pull request has been created to manually resolve the merge conflicts and test the changes. See ${TEST_PR_URL} for more details."
          fi
          gh pr comment ${{ github.event.issue.number }} --body "${NOTICE_COMMENT_TAG}
          ${body}"
